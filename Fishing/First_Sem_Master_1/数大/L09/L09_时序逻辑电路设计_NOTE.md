[[Fishing/First_Sem_Master_1/数大/数大|数大]]
# 1.引言
**时序逻辑的定义:**  
典型的逻辑电路如下图![[support/img/Pasted image 20231213200320.png|500]]
**存储单元的分类:**(按照存储器在系统芯片中的摆放位置分类)
1. 前台存储器--嵌入在逻辑中的存储器
	1. 寄存器堆（Register File）
	2. 锁存器堆（Latch File）
2. 后台存储器--大容量的集中存储内核
	1. 嵌入式存储[[Fishing/First_Sem_Master_1/数大/L02/L02_器件与互连线_NOTE#(2)电阻工作区|L02_器件与互连线_NOTE]]器（Embedded ROM，RAM，Flash等）
	2. 独立的存储器（Stand alone ROM，RAM，Flash等）
**锁存器和寄存器:**
- 区别
	- 锁存器是电平触发(高电平透明或者低电平透明)
	- 寄存器是边沿触发(时钟上升沿或者下降沿时保存数据)
![[support/img/Pasted image 20231213200726.png|500]]
**存储单元的分类:**(按照数据的存储机理分类)
1. 静态![[support/img/Pasted image 20231213200844.png#right|静态存储|200]]
	1. 信号可以无限保持
	2. 对扰动不敏感
	3. 速度相对慢，面积相对大



2. 动态![[support/img/Pasted image 20231213200911.png#right|动态存储|200]]
	1. 要求定期刷新，要求从电容中读出信 号时不会干扰所存储的电荷，因此要求通过具有高输入阻抗的器件来读取
	2. 速度快，面积小

## (1)时序分析基础
### A 时序参数的一般定义
1. 建立时间(set-up): $t_{su}$
2. 维持时间(hold):$t_hold$
3. 时钟至输出的时间(clk-q)<span style="background:#affad1">(max)</span>:$t_{clk-q}$
4. 时钟周期:T
5. 数据至输出的时间(d-q)(max): $t_{d-q}$
**如何理解clk2q:** 假设建⽴和维持时间都满⾜要求，<span style="background:#affad1">那么输⼈端D处的数据则在最坏情况下的</span>传播延时$t_{clk-q}$(相对于时钟边沿)之后被复制到输出端Q。
**如何理解d2q:** 主要发生在Latch的透明期间, d2q, 通过Latch内部结构传送过去数据  
**不是很理解上边说的c2q**: 从D触发器的[[Fishing/First_Sem_Master_1/数大/关键问题/专题#2. D触发器|原理]]来看, <font color="#ff0000">也不是很会</font>
或者这个问题可以表述为: 两者是纯纯的平行关系, 还是一种延时的不同表达或者体现??反正至少不能相加吧
![[support/img/Pasted image 20231213205938.png]]
### B 由建立时间进行的约束
![[support/img/Pasted image 20231214101921.png|500]]
$t_{setup}$是和critical path紧密相关的. 也就是, 你要是有一个路径巨长, 在上边需要花的时间很长, 那你这个信号来了之后, 在下一个时钟边沿到来的时候, 你这个信号得早到一会吧, 满足下一个FF的建立时间. 因此有约束:$$\mathbf{t}_{\mathrm{critical}}<\mathsf{T}-\mathbf{t}_{\mathrm{c2q}}-\mathbf{t}_{\mathrm{su}}$$
### C 由保持时间得到的约束
![[support/img/Pasted image 20231214102530.png|500]]
保持时间是和最短路径相关的,这里有一个关键就是理解critical和shortest, 这个是出现在组合逻辑的时候, 就像你沿管道发射两个不同气味的一段长度相同(时钟周期)的气体, 第一段气体进了一个很长的管道(critical path), 第二段气体进入了很直的管道(shortest path), 第一段气体到出口还没到允许结束的时候(hold time), 你第二段气体不能来混淆,出现竞争. 

---
综合以上B和C的内容所说的, 就有这两个图: 
![[support/img/Pasted image 20231214103935.png|+grid]]![[support/img/Pasted image 20231214104032.png|+grid]]
### D 例子
![[support/img/Pasted image 20231214104116.png|500]]
> 在此思考一下c2q, 就像多路选择器, clk其实就是一个选择信号对吧, 参与实际的组合逻辑运算, 因此等效一个输入端口, 所以D2q此时被截断成C2Q.

Slack(余量)=希望的min.T - (最长路径的传播时间+建立时间)
### E 最长路径和最短路径
![[support/img/Pasted image 20231214104556.png|400]]
**污染延时**的定义有了
# 2.静态锁存器（Latch）与寄存器（Register）
## (1)双稳性原理
静态存储器⽤*正反馈*来建⽴双稳电路，这⼀电路具有两个稳定状态，分别代表0和1。
因此交叉耦合的两个反相器形成了双稳电路 ----也就是⼀个电路具有两个稳定状态，每⼀ 个对应⼀个逻辑状态。**这⼀电路可⽤来作为存储器，存放1 或0(相应于位置A 和B)。**
> [!question] 正反馈
> 假设交叉耦合的⼀对反相器偏置在C 点。那么对这⼀偏置点的⼀个⼩偏移(也许由噪声引 起)会沿这⼀电路环路被放⼤和再⽣。这是由于沿此环路的增益⼤于1造成的。这⼀影响显示在 图7.5（a)中。假设⼀个⼩偏移$\delta$加在Vn上（偏置在C点）。这⼀偏移被反相器的增益所放⼤。放 ⼤的偏差⼜加到第⼆个反相器并再次被放⼤。⼿是偏置点从C点移开，直到达到A 或B中的⼀ 个⼯作点为⽌。


![[support/img/Pasted image 20231216104534.png|400]]
当翻转区中反相器的*增益*⼤于1时，只有A 和B是稳定的⼯作点，⽽ C是⼀个亚稳态⼯作点(亚稳态就是看势能的二阶导数的那个意思). 
> [!question] 增益
> 这里的增益就是指的对于一个弱小的<font color="#ff0000">变化</font>的放大倍数

![[support/img/Pasted image 20231216105816.png|400]]
(a)图的意思就是从C进行偏移一小点, 就跑了. (b)图的意思就是, 就算我跑了, 我还能回来.  **注意, 一个是应该大于1, 一个是远小于1.**
#### A: 双稳电路中, 从一种状态变为另一种状态的方法
由于稳定性的先决条件是环路增益G⼩于1，所以可以通过使<font color="#ff0000"> G增加到⼀个⼤于1的值</font>⽽使 A(或 B）暂时不稳定来达到改变状态的⽬的。<span style="background:#d3f8b6">(改变的是波形还是工作点)</span>一般的做法是在$V_{i1}$或者$V_{i2}$处增加⼀个触发脉沖. 
**例如:** 假设该系统处在位置A, 此时有v $V_{i2}=0$. 加入脉冲信号, 迫使$V_{i1}=1$, 这会引起两个反相器<span style="background:#d3f8b6">同时导通一段时间</span>(反相器的导通??), 并使环路增益大于1. <span style="background:#d3f8b6">正反馈再生了触发脉冲的效应</span>, 于是是电路移向另⼀状态(在这⾥为状态B)。
**注意**, 触发脉冲的宽度只需稍⼤于沿该电路环路的传播延时，也就是反相器平均传播延时的2倍。
**对于以上的解释:** 意思应该是, 给一个脉冲信号, 别管用什么方法, 使得$V_{i1}=1$, 在这个==**过程之中**==, 由于输入转换的过程(强制改变信号不是一下子就改变了, 有斜率, 有延时)中, 会有使得两个管子的PN同时导通的时候, 这个时候就是增益大于1的时候. 但是疑问是, 如果这么解释的话, **==为啥还需要正反馈的作用==**, 我第一次1的输入给输出的改变一下子就一步到位了, 不需要什么别的了啊. 延时两倍的意思就是, 等我强制1进入导致最后的输出为要经历两级的延时, 为构成全时间的改变, 所以需要保持两个延时至少.==由于写入信号只需要持续这么短的时间, 是一个脉冲信号, 是一个触发, 因此双稳态也叫做触发器==.
##### a:强制写入
设![[support/img/Pasted image 20231231150004.png#right|强制写入|200]]计反馈环和输入电路的晶体管尺寸，保证写入功能. 
> [!question] 尺寸为什么需要设计和怎么设计
> 画出管级的结构之后可以发现, 假设强制写入一个1, 也就是连到一个高电平之后, Clk当然为1的时候, 原来的Data为0, 也就是下边第二级的反相器的nmos导通, 下拉, 此时X节点处为传输管的等效电阻(np并联)和第二级反相器n管等效电阻的分压, 因此需要设计尺寸.有结论如下
> - 传输管的电阻越小, X节点的电压越高, 这也是输出电阻越小, 驱动能力越大的一个体现.(**==有无反例, 或理论支撑为什么==**)


##### b:切断反馈环写入
反![[support/img/Pasted image 20231231150019.png#right|切断反馈环|200]]馈环打开后，新的值比较容易写入
基于多路选择器（Mux）的方式，比较常用
> [!question] 在反馈环不被切断的一瞬间, 能够覆盖延时吗?
> 假设, 现在处于写入状态, 也就是Clk=1, 那么, 一旦断开, 节点X会因为写入信号被切断而经历一级传输管延迟之后变为高阻, 但同时, 写入信号会经过上边那个传输管, 历经一个传输管延迟之后变为输入的数据, 正好续上. 
> - **==传输管的延迟是多少?如何计算?==**


#### B: 命名规则
1. **锁存器（Latch）是电平敏感的（level sensitive）**
	- 电平灵敏，不是边沿触发
2. **寄存器（Register）是边沿触发的（edge-triggered）**
	- 寄存器为存放二进制数据的器件，通常由Latch 构成
3. **触发器（ Flip-flops ）是由交叉耦合的门构成的任何双稳态元件**
	- <span style="background:#d3f8b6">Latch和Register都可能包含flip-flop结构</span>
## (2)基于多路开关的锁存器
电平灵敏!!!!!!!!!!!!
分为正锁存器和负锁存器![[support/img/Pasted image 20231231150355.png|500]]
![[support/img/Pasted image 20231231150410.png|400]]
#### A:多路开关锁存器
##### a:传输门实现
缺![[support/img/Pasted image 20231231150442.png#right|传输门锁存器|300]]点: 时钟信号的==**活性系数**==为 1，有 4 个负载，功耗很大
> [!question] 活性系数



##### b:NMOS传输管实现
优![[support/img/Pasted image 20231231150615.png#right|nmos锁存器|200]]点: 时钟负载小
缺点: 第一个反相器的输入的高电平降低(NMOS传输弱1)，**==从而影响噪声容限和开关性能，产生静态功耗==**
> [!question] 弱1的影响
> 1. 开关性能???
> 2. 噪声容限: 
> 3. 静态功耗: 第一个反相器的PMOS不能完全关断
##### c: 单纯使用锁存器存储产生的问题
> ![[support/img/Pasted image 20240101215631.png|400]]
> ![[support/img/Pasted image 20240101215710.png|400]]
> ![[support/img/Pasted image 20240101215725.png|400]]

==*这就从锁存器变成了寄存器*==
**==但是上边的第一张slide里边的延时公式和为什么要组成闭环还不知道==**
## (3)主从边沿触发寄存器
实现寄存器的方法是使用主从锁存器, 且锁存器的正负相反.
**其工作原理主要如下:** 
下图的结构, Master为负锁存器, Slave为正锁存器. 低电平期间, Master透明, 嘎嘎变. 但是Slave只能停留在高电平期间主级输出的的最后一个值. 当低电平转换为高电平的时候, Master保留输入数据的最后一个值, Slave变成透明的, 嘎嘎变(但由于输入数据不变, 所以也不动), 再次切换为低电平的时候, Slave保持住第一级输出的最后一个值, 其实也就是刚刚那个值, Master开始嘎嘎变了. 在效果上看, 好像是在时钟的上升沿, 数据被抓取到输出并且保持一个周期.
- 抓取的概念其实就是, 这个时钟沿是最后一个数据, 此时主机保持, 从级透明
- 延时的概念也比较明晰, 最终的输出就是D经过两级锁存器的延时
 ![[support/img/Pasted image 20231231150724.png|450]]
#### A:晶体管实现（传输门实现）
![[support/img/Pasted image 20231231150810.png|500]]
##### a:时序特性
![[support/img/Pasted image 20231231150834.png|500]]
> [!Danger] 7.1
> 可以去掉反相器$I_{1}$和$I_{4}$⽽不影响功能, 留着有什么好处吗? 
> -  传输门信号的两个栅极信号是不同时到达的, 在其中一个栅极打开而另一个没打开的时候, 传输过去的信号只能是强1和弱0或者弱1和强0的形式. 
> - 

**传播时间**
- [x] 为什么不计算$I_{4}$
- [x] 为什么比看起来小
这里的传播时间看起来很小, 但需要这么想, 也就是蓝色的那一条线, 就是信号提前来了, 存在了Master里边, 第二级一透明, 第一级通过一个传输门和一个反相器直接传到了输出端.
传播延时, 在Master为透明的期间, 由于数据早就已经到了T3的输入端(因为建立时间), 因此时钟一打开, 只需要一个传输门和反相器的时间就可以到达输出端, 因此传播延时为$t_{pd,INV}+t_{pd, TX}$
**建立时间和保持时间**
==*有关建立时间和保持时间的叙述和推导过程参照*==[[Fishing/First_Sem_Master_1/数大/关键问题/时序问题|时序问题]]
##### b:仿真例子
- **建立时间和保持时间, 如何从仿真之中获得?**
为了用 SPICE 得到寄存器的建立时间，我们将输入(从左边)逐渐靠近时钟边沿直到电路失效。图7.11显示了假设输入与时钟边沿偏差210 ps和 200 ps 时建立时间的模拟结果。对于210 ps的情况，输入$D$ 的采样值是正确的(在这一情况下，输出$Q$ 维持在$V_{DD}$的值)。对于偏差200 ps 的情况，传送到输出的值是错误的，因为输出$Q$变化到了0。节点$Q_{M}$开始上升，而$I_{2}$的输出(传输门$T_{2}$的输入)开始下降。然==*而时钟在传输门$T_{2}$两端的节点稳定到同一个值之前就已有效*==，因此造成不正确的值写入主锁存器。所以这一寄存器的建立时间是210 ps。
==**(感觉涉及到更细的过程, 即没有闪烁正确的时候, 一个闪烁如何把一个闪烁覆盖掉的问题)**==

![[support/img/Pasted image 20231231150902.png|500]]
- **满足建立时间和保持时间之后, 如何通过正确的波形查看延时?**
![[support/img/Pasted image 20231231150921.png|450]]
##### c:降低时钟负载（用强制写入代替了MUX）
一个时钟八个负载电容(不计算时钟反相器的, 因为可以分摊), 而负载直接影响==**时钟的功耗(为什么?什么功耗?)**==, 因此需要减小时钟的负载. 以稳定性为代价降低时钟负载的⼀个⽅法是使电路成为有⽐电路,==*也就是强制写入*==
减少时钟负载的代价是增加了设计过程的复杂性(因为要设计尺寸)。传输门(T1)以及它的源驱动器必须⽐反馈环路反相器(I2)更强才能切换交叉耦合反相器的状态。==**传输门所要求的尺寸可以用类似于第6 章中分析电平恢复器件尺寸的方法来推导。**==反相器 $I_{1}$的输入必须超过它的开关阈值以便能够产生翻转。如果在传输门中要使用最小尺寸的器件，==一定要注意把反相器$I_{2}$的晶体管设计得更弱。这一点可以通过使它们的沟长大于最小尺寸来实现。在传输门中希望使用最小尺寸或近于最小尺寸的器件，以降低锁存器和时钟分配网络的功耗。==
> [!tip] 反相传导

![[support/img/Pasted image 20231231151017.png|500]]
##### d:时钟交迭（Overlap）引起的问题
1. **Both = 1:** 
	1. ![[support/img/Pasted image 20240102194300.png#right|直接连通|300]]**race condition**
	  右图会造成输出端的数据可以在时钟的上升沿改变，这是一个负沿触发寄存器所不希望的。这被称为竞争(race)情况，此时，输出$Q$ 的值取决于输人 $D$ 是在$\overline{CLK}$的下降沿之前还是之后到达节点$X$。如果节点$X$ 在亚稳态时被采样，那么输出将会切换到由系统噪声决定的一个值.
	2. **undefined state**![[support/img/Pasted image 20240102194614.png#right|未定义状态|300]]
	   多路开关型寄存器的基本优点是在采样期间反馈环断开，因此器件的尺寸对功能的影响不大。然而如果在$CLK$ 和$\overline{CLK}$之间存在时钟重叠，那么节点$A$ 同时被$D$ 和$B$ 驱动，造成不确定的状态。


2.  **Both = 0:**
	When CLK and !CLK are both low (0-0 overlap) level of X stored on parasitic capacitances ==**(might discharge)**==![[support/img/Pasted image 20240102194734.png|500]]
	
##### e:两相不交迭时钟
为了避免这些问题，可以采用两相不重叠时钟 $PHI_{1}$和 $PHI_{2}$( $见图7.16$) $,并保持两相时钟之间的不重叠时间$$t_{non_overlap}$足够长，因而甚至在存在时钟布线延时的情况下也不会有任何重叠发生。在不重叠时间内，触发器处在高阻抗状态——反馈环开路，环路增益为零，并且输入被断开。==**如果这一情况保持的时间太长，漏电将破坏这一状态，因此称其为伪静态：根据时钟的不同状态， 寄存器采取了静态或动态的存储方式。**==
![[support/img/Pasted image 20231231151120.png|500]]
> [!summary] 产生不不交叠时钟
> 使用SR锁存器, 原理如下, 具体参见Cornell Slides
> ![[support/img/Pasted image 20240102200024.png]]![[support/img/Pasted image 20240102200053.png]]
# 3.动态锁存器（Latch）与寄存器（Register）
**为什么需要动态锁存器和寄存器:**
1. 静态⻔的主要缺点是它⽐较复杂
2. 在速度很快的电路上, 不需要保存的值一直有效. 
**特点:**
1. 比静态Latch和Register 结构简单
2. 基于在寄生电容上存储电荷，由于==**漏电(为啥电荷泄露)**==需要周期刷新
3. ==**高阻抗的内部动态节点易受噪声源的干扰**==
4. 漏电影响了低功耗技术（例如无法停止时钟以节省功耗）
5. 读操作不破坏信息：==**因此需要输入阻抗高的器件(阻抗高, 电容小, 耦合不了??)**==
**结构:**![[support/img/Pasted image 20231231151320.png|550]]
### (1)动态传输门边沿触发寄存器
#### A工作原理
图7.23 是一个基于主从概念的完全动态的正沿触发寄存器。当 $CLK=0$ 时输人数据在存储节点$A$ 被采样，该节点具有一个等效电容$C_{1}$,它由$I_{1}$的栅电容、$T_{1}$的结电容和$T_{1}$的栅重叠电容组成。在此期间，从级处于维持模式，其节点 $B$ 处于高阻抗(浮空)状态。在时钟上升沿时，传输门$T_{2}$导通，于是恰在上升沿之前在节点$A$ 上所采样的值就传送到输出 $Q$(注意，在时钟高电平阶段， 由于第一个传输门关断，节点 $A$ 是稳定的。现在节点 $B$ 存储了节点 $A$ 的相反状态。这一边沿触发器的实现是非常高效的，因为它只需要8个晶体管。采样开关可以用纯 NMOS 传输管来实现， 这样就更加简单，只需要 6 个晶体管。晶体管数目的减少对于高性能低功耗系统极具吸引力。
![[support/img/Pasted image 20240102203122.png|400]]
#### B三大时间
- **建立时间**: 第二个传输门啪一打开, 传过去的必须是对的信号, 传过去的源头固定, 就是节点1储存的电荷代表的电压, 而D传到这个1点需要一个传输门的延时, 所以建立时间为$t_{_{pT1}}$
- **保持时间**: 第一个传输门啪就关断了, ==电荷只要能充ok, 节点1立马就给后边供上了==, 不需要什么保持
- **传输延时:** 考虑按照建立时间刚刚建立好的信号, 提前一个$t_{_{pT1}}$来, 时钟上升沿到来时, 1刚存好状态, 因此, 影响传播到I1输出需要时间, 依次类推, 就能得到输出延时为两个反相器和一个I2
> [!question] 建立时间不满足呢?
> 延时对, 1立即往后开始传的值是错误的, 需要在Q多等待一个传输门的时间才对, 因此保证输出和结构对应正确下, 建立时间只有一个值
> 

![[support/img/Pasted image 20231231151554.png|500]]
#### C: 应用限制
> 对于这样⼀个动态奇存器，需要好好考虑的是存储节点(即状态)必领周期性地刷新，以防⽌ 因电荷泄漏、⼆极管泄漏或亚國值电流引起的电荷丢失。在数据通路电路中刷新的频率不是⼀ 个问题，因为寄存器受到时钟周期性的控制，所以存储节点在不断更新。
1. 在稳定性⽅⾯的考虑限制了它们的应⽤, 例如, 如图7.23这样的⼀个完全动态的电路中，==**⼀个被电容耦合到内部存储节点上的信号节点会注⼊相当⼤的噪声⽽破坏状态。这⼀点在 ASIC 设计流程中特别重要，因为它对信号节点与内部动态节点之间的耦合缺乏控制。Coupling between signal nets and internal storage nodes (can destroy FF state)**==
2. 漏电电流引起的另⼀个题是：⼤多数现代处理器要求时钟能够减慢或者完全停⽌，以便在低活动性期间节省功率。Leakage currents cause state to leak with time
3. ==**内部动态节点并不跟踪电源电压的变化**==。例如，在图7.23的电路中，当 CLK 为⾼电平时节 点A维持它的状态，但它不会跟踪由$I_{1}$所看到的电源电压的变化。其结果是降低了噪声容限。
**解决方法:**
⼤![[support/img/Pasted image 20240102204128.png#right|伪静态|300]]多数这些问题都可以通过增加⼀个弱的反馈反相器使电路成为份静态来解决（见图7.25）。虽然这要增加少量的延时，但却明显政善了抗噪声的能⼒。==*除⾮寄存器是⽤在⾼度控制的环境中（例如定制设计的⾼性能数据通路），它们都应当设计成伪静态的或静态的*==。这对本节讨论的所有锁存器 和寄存器都适⽤。
**工作原理:** 
内部节点存储状态之后, 反馈反相器可以对节点进行持续的充放电以保持状态, 因此增加了抗噪声的能力![[support/img/Pasted image 20240102204705.png|500]]
> [!question] 延时为何增加?
> 难道是因为增加了电容? 因为路径不变啊, 节点电容倒是会变化
#### D:==*时钟交叠*==
- **(0-0)重叠区**，$T_{\mathrm{1}}$的PMOS 和$T_{2}$的 PMOS 同时导通，形成数据从寄存器的$D$输入流到$Q$ 输出的直接通路。换言之，此时出现了竞争情况。如果重叠期间很长，输出$Q$可能在下降沿时就改变，显然，对于正沿触发寄存器这是一个不希望有的效应。
	- **解决方案**: 保证在$D$ 输入和节点$B$之间有足够的延时，以使主级采样的新数据不会传送到从级(渡过交叠的那一会)。一般来说，内置单个反相器的延时就足够了(不需要加别的了)(因为交叠也就是时钟反相器的交叠)。对重叠期间的限制条件为    $t_{overlap0-0}<t_{T1}+t_{I1}+t_{T2}$, 这个时间内都到不了, 那我时钟就真的关断了. 
-  **(1-1)重叠区**也是一样，这时存在一条通过$r_{1}$的 NMOS 和$T_{2}$ 的 NMOS 的输人至输出路径。
	- **解决方案**: 可以通过强加一个维持时间约束来解决。即数据必须在高电平重叠期间稳定对(1-1)重叠的限制条件为  $t_{hold}>t_{overlapl-1}$ 
![[support/img/Pasted image 20240102205858.png|500]]
### (2)$C^2MOS$
==*核心思想: 主从概念*==
#### A:工作原理
- Clk=1, Clk'=0: 此时, $C_{L1}$就是反相器的输出, 而从级$C_{L2}$由于被M8和M7阻隔了, 所以, 高阻输出
- Clk=0, Clk'=1: 此时, 情况反过来, $C_{L1}$的值可以传到$C_{L2}$. 
![[support/img/Pasted image 20240102212750.png|500]]
#### B: 交叠处理
首先考察, 00交叠原本为01还是10, 都有可能
- 10时要求, 从级求值, 主级保持. 
- 01时要求, 主级保持, 从级求值
00时, 只有M4和M5打开, 因此, 两个都不可能求值, 也都不可能打开, ==唯一的可能就是,在Clk开始重叠的同时, D从1变成0==,  $C_{1}$==的值从0变成1了==(看清楚, 不是变0, 连到了一个栅极上边). ==若是下一时刻是01, 那么开始重叠是在上升沿之后==, 这种情况确实D有可能出现, 但是下一时刻01是重新求值, 所以不影响输出.若下一时刻是10, 那么重叠时开始于上升沿之前, ==这一情况肯定不可能发生==.(发生了, 那说明原本的值就是错的).11是同样的道理,但是下一刻变为10说明重叠开始于时钟上升沿, 可能发生, 也会出错, ==*所以要求一个保持时间*==.下一刻变为01既没可能, 也没危险.
![[support/img/Pasted image 20240102214243.png|500]]

11是同样的道理,但是下一刻变为10说明重叠开始于时钟上升沿, 可能发生, 也会出错, ==*所以要求一个保持时间*==.下一刻变为01既没可能, 也没危险.![[support/img/Pasted image 20240102214156.png|500]]
#### C:Clk非阶跃信号的影响
然⽽，如果时钟的上升和下降时间⾜够慢， 那么就会存在⼀个 NMOS 和 PMOS 管同时导通的时间间隙。它在输⼈和输出之间形成了⼀条通路，可以破坏电路的状态。模拟显示只要时钟上升时间(或下降时间）约⼩于寄存器传播延时的5 倍，该电路就能正确⼯作。这⼀条件并不⼗分严格，它在实际的设计中很容易达到。**==时钟较慢时，存在发⽣竞争状况的可能性。==**![[support/img/Pasted image 20240102220136.png|500]]
#### D:优点
![[support/img/Pasted image 20231231151618.png|500]]
#### E:双边沿寄存器
⾄此，我们主要集中于仅在时钟的⼀个边沿(上升或下降）上采样输⼈数据的边沿触发寄存 器。也可以设计在两个边沿上都采样输⼈的时序电路。这⼀电路的优点是需要较低的时钟频率 （原来频率的 1/2）来完成同样功能的数据处理量，因此节省了时钟分布⽹络中的功率. 
> [!question] 三态驱动器

**工作原理:** 
当时钟在高电平时，由晶体管$M_1~M_4$组成的正锁存器在节点$X$上采样被反相的$D$输入。节点$Y$维持在稳定状态，因为器件$M_9$和$M_{10}$关断。在时钟的下降沿，上面的从锁存器$M_s\sim M_s$导通并驱动被反相的$X$值到输出$Q$。在时钟为低电平阶段，下面的主锁存器$(M_1,M_4,M_9,M_{10})$导通，在节点$Y$上采样被反相的$D$输入。注意，==*由于器件$M_1$和$M_{4}$被重复使用，所以减少了$D$输入的负载*==。在上升沿，下面的从锁存器导通并驱动被反相的$Y$值到节点$Q$。数据因此在两个边沿上都发生改变。<font color="#ff0000">注意，上下两个从锁存器以互补的形式工作，即在每一个时钟阶段，它们之中只有一个是导通的。</font>
![[support/img/Pasted image 20231231151632.png|600]]
> [!danger] 7.5
> 指出来⽤双边沿寄存器对时钟分布⽹络的功耗有何影响。
### (3)真单相钟控寄存器（TSPCR）
只⽤单相位时钟的寄存器。
#### A:工作原理
对于正锁存器，当$CLK$ 为高时， 锁存器处于透明模式，相当于两个串联的反相器；因此锁存器是非反相的，并把输入传送到输出。反之，当$CLK=0$ 时，两个反相器都不起作用，锁存器处于维持状态。只有上拉网络仍起作用，而下拉网络则不工作。==由于采用了两级串联的方法，在这一模式下不会有任何信号可以从锁存器的输入传送到输出端。(若不采用串联的话, Clk=0之后, In从1变为了0, 那输出节点就会从0变为1.但是一旦串联, 这个从0变为1的节点所导致的1不会传到out)==一个寄存器可以通过串联正、负锁存器来构成。- 
![[support/img/Pasted image 20231231151647.png|500]]
#### B:优缺点
- 优点1: 时钟负载:与通常的传输门寄存器或 C$^{2}$MOS 寄存器类似
- 优点2:是只用单相位时钟。
- 缺点1:是稍微增加了晶体管的数目——现在需要 12 个晶体管。
- 缺点2:需要提醒读者注意的是，在使⽤图7.30 类型的动态电路时必须⼗分⼩⼼。时==*钟处于低电平 (对于正锁存器）时，输出节点有可能浮空*==并受到其他信号耦合的影响。==**同时如果输出节点驱动传输⻔，也可能发⽣电荷分享。动态节点应当借助静态反相器隔离起来，或者设计成伪静态以提⾼抗噪声能⼒。**==
- 优点3: 和许多其他锁存器系列相比，TSPC 还有一个至今还未说明的额外优点：可以将逻辑功能嵌人锁存器中。==**这就减少了与锁存器相关的延时**==。图7.31(a)概括了嵌人逻辑的基本方法，而图7.31(b)是一个正锁存器的例子，它除了完成锁存功能之外又实现了两个输入$In_{1}$和$In_{2}$的 AND 功能。==**虽然这一锁存器的建立时间比图 7.30 的实现有所增加，但这一数字电路的整体性能( 即时序电路的时钟周期)得到了提高：建立时间的增加一般要小于一个 AND 门的延时。**==这种将逻辑嵌人锁存器的方法已广泛用于 EV4 DEC Alpha 微处理器$^{[\text{Dobberpuh}92]}$及其他许多高性能处理器中。![[support/img/Pasted image 20240102222642.png|500]]
#### B:优化
正锁存器,![[support/img/Pasted image 20240102223806.png]] 相当于NMOS只能传输一个弱1, **==这在刚刚也存在==**, 只是没有引出来.
这个结构的意义相当于问第二级Clk的意义, 如果把第二级Clk换掉了, 串联两级就没用了, 所以把这个A弄到下面来, 就是怕Clk变为0之后, In从0变成1之后, 这个1也传到了第二级nmos的栅极, 所以, 放在Clk的下面就可以隔离开了. 

![[support/img/Pasted image 20231231151658.png|550]]

# 4. 流水线（Pipelining）
流水线的基本思想: 一个时间点上, 多个运算模块应该同时工作. 
为什么加上个寄存器就能同时工作了?
因为, 数据是交替闪烁的, 闪烁过一个运算模块就会变一个值, 为了满足数据的建立时间, 因此时钟周期需要长, 长到满足逻辑的运算. 也就是寄存器存值的时候(边沿), 时钟应该够大使得逻辑可以计算完成. 一个时钟周期内, 由于前边的寄存器只传过来一个数据, 因此, 一个(这么长)时钟周期内这三个运算模块只能送一次.
加了寄存器, 逻辑要求使得时钟周期变短, 还是一个时钟周期内只能处理一次数据, 但是时钟周期变短了, 数据可以一次排布在三个寄存器的, 也就是, 每==*一个运算模块算完, 下一个数就接着存进来了, 不需要等到全部三个运算完成*==, 因此速度变快.
![[support/img/Pasted image 20231231151717.png|500]]
![[support/img/Pasted image 20231231151728.png|500]]
![[support/img/Pasted image 20231231151737.png|500]]
> 等待时间: 这⾥等待时间定义 为数据从输⼈传送⾄输出所需要的时钟周期数。
# 5.施密特触发器（Schmitt Trigger）
施密特触发器两个重要特性：
1. 对变化很慢的输入波形，输出端有快速的翻转响应，有利于恢复信号波形。
2. 正向变化和负向变化的输入信号有不同的开关阈值，类似磁滞（Hysteresis）特性的VTC，可以抑制噪声。
![[support/img/Pasted image 20231231151755.png|400]]![[support/img/Pasted image 20231231151838.png|400]]
**核心思想:** ==*正反馈*==
![[support/img/Pasted image 20231217161242.png|500]]
当$V_{in}=0$的时候, X=VDD, 因此$V_{out}=0$, 这样M4就导通, M3就关断. 但是我不懂从0到1的过程之中, 为什么要驱动的是M2和M4--M1. 
- 假设Vin从0->VDD，M2处于导通上拉状态；
	Vx初始电位为VDD，Vout初始电位也为0，所以M4也处于导通上拉状态；这样相对于普通反相器多了一条上拉path，所以翻转电压Vtrig+要变得更大才能使得NMOS M1下拉改变输出Vx由VDD->0 ；
	==在数学上来看, 也就是改变了上边的PMOS的k, 下边的k不变==
- 同理Vin从VDD->0，M1处于导通下拉状态；
	Vx初始电位为0，Vout初始电位也为vdd，所以M3也处于导通下拉状态；这样相对于普通反相器多了一条下拉path，所以翻转电压Vtrig-变得更小才能使得PMOS M2上拉改变输出Vx由0->VDD；

VTC: ![[support/img/Pasted image 20231231151914.png|500]]
另一种![[support/img/Pasted image 20231231151929.png|600]]
$V_{in}=0\rightarrow1:$
- 0: 当输入为0的时候, 首先可以确定的是M1,M2为截止, M4为导通. 此时假设$V_{out}$为0的话, 由于M4导通, M6和M3的栅极电压都为0,因此都导通, 输出也会被拉升至VDD.因此此时M3线性导通, 输出$V_{out}=VDD$.此时M6截止, M5导通, X处的电压为$V_{DD}-V_{T5}$.
- 逐渐升高至$V_{T1}$以上时, M1打开,此时X处的电压会被逐渐拉低. 此时的M2还开启不了, 因为其S端的电压为X处的电压, 大于0. 因此M2要求的$V_{In}$开启电压要大于M1的开启电压,而又因只有M1和M2同时导通时, 输出才会被拉倒0.
- 随着$V_{In}$逐渐升高,M2逐渐开启,一旦M2开启, 输出会被拉低到0, 此时M5逐渐关断,X处的电压逐渐降低,M2会处于更加深度的开启状态,因此有陡峭的的过渡转化区.因此可以把阈值当做M2刚开启的时候$V_{In}$当做阈值电压. 
- 分析M2刚开启的时候, M5肯定是处于饱和区, 而此时X的电压在M2还未导通的时候为$V_{DD}-V_{T5}$, 因此此时的M1也是饱和导通状态. 因此此时$V_{DD}$通过M5和M1接到地.
$V_{in}=0\rightarrow1:$
- 同上述分析, M3会晚于M4导通, 因此会形成滞后, 这也是类似于磁滞回线的原因. 而陡峭的原因也是因为正反馈的存在, 其中M6在M4的S级产生的反馈点将会带来正反馈, 产生输出的翻转.
假设处于速度饱和, 因此带入以下公式,:$$I_{D}=k\left(V_{GT}V_{min}-\frac{V_{min}^{2}}{2}\right)\left(1+\lambda V_{DS}\right)$$
其中, $V_{min}=V_{DSAT},\lambda =0$.
# 6.总结

1. ==*时序逻辑*==的概念，==*双稳态*==的概念，==*时序参数*==的定义
2. 各种==*静态锁存器*==和==*寄存器*==（触发器）的电路形式与特点，时序参数的分析
3. 各种==*动态锁存器*==和==*寄存器*==的电路形式与特点分析，包括动态传输门边沿触发寄存器、C2MOS寄存器和TSPC寄存器等
4. ==*流水线*==的概念及采用流水线结构的优点
5. ==*施密特触发器*==特点、电路形式及其触发电压的分析

