[[Fishing/First_Sem_Master_1/数大/数大|数大]]
# 一、同步时序的分类
## 1.同步（synchronous）
**信号与本地**时钟具有<font color="#ff0000">完全相同的频率</font>，且与本地时 钟保持一个已知的<font color="#ff0000">固定的相位差</font>
**信号确定期**: 数据有效时期;
**信号不确定期**: 数据无效时期
同步时, 确定期与时钟同步, 可以直接采样
信号不确定期的长度确定了系统工作的最高频率
![[support/img/Pasted image 20240115211207.png|500]]
> [!question] 如何理解确定期, 不确定期?
> 是不是组合逻辑的那一块就是不确定期
## 2.中等同步（mesochronous ）
信号与本地时钟具有<font color="#ff0000">完全相同的频率</font>，但具有<font color="#ff0000">未知的相位差</font>
![[support/img/Pasted image 20240115211308.png|500]]
- 数据在*两个不同的时钟域*之间传送，需要采用==中等同步器==使之与接收模块的时钟同步
### (1)中等同步器
![[support/img/Pasted image 20240115211652.png]]

## 3.近似同步（plesiochronous）
信号与本地时钟具有<font color="#ff0000">名义上相同的频</font>率，但<font color="#ff0000">真正 的频率却稍有不同</font>
- 当长距离通信（两个相互作用的模块具有各自独立的 晶振）时，两个时钟间的相位差将随时间漂移。
- 需要采用缓冲技术以保证能接收到所有的数据。
![[support/img/Pasted image 20240115211734.png|500]]
### (1)缓冲技术
![[support/img/Pasted image 20240115211829.png]]
![[support/img/Pasted image 20240115211835.png]]

## 4.异步（asynchronous）
信号<font color="#ff0000">不服从本地时钟，可以在任何时候随意变化</font>
- 通过检测信号的随意变化并将等待时间（Latency）引入到与本 地时钟同步的数据流中，以“*同步”异步信号*
- 完全取消本地时钟，采用自定时的异步电路，通过<font color="#ff0000">握手协议</font>实现 模块间正确的操作次序
![[support/img/Pasted image 20240115212055.png|500]]
# 二、时钟问题
同步电路时序要求![[support/img/Pasted image 20240115212247.png|500]]==当R1和R2的时钟信号同时变化时==应满足：(前提很重要)

$$
\color{red}{t_{clk-Q}+t_{p,comb}+t_{setup}\leq T}
$$

$$
\color{red}{t_{cdreg}+t_{cdlogic}\geq t_{hold}}
$$

^57c3df

## 1.时钟的非理想现象（时钟偏差和时钟抖动）
### (1)时钟偏差（Clock Skew）
![[support/img/Pasted image 20240115213034.png|400]]
- 定义: 空间上两个不同点处**时序上等同**的两个时钟沿在到 达时间上的偏差$\delta(i,j)=t_{i}-t_{j}$
- 由时钟*路径上的失配与时钟负载上的差别*引起，取决于数 据与时钟
- 根据*布线方向*的不同，时钟偏差可正可负
- 具有确定性（从一个周期至下一个周期是时不变的）
- 时钟偏差不会引起周期的变化，只会引起相移（相位偏移）
#### A:时钟偏差对性能的影响
![[support/img/Pasted image 20240115214902.png]]
##### a:建立时间
对于建立时间的影响, 也就是对周期的影响, 也就是对性能的影响.
*<span style="background:#d3f8b6">频率和延时??</span>*
时钟偏差现象⽆论对时序系统的性能还是功能都有很⼤的影响。⾸先，考虑时钟偏差对性 能的影响。从图 10.6中可以看到，由R1在边沿①处采样的⼀个新输⼈ in将传播通过组合逻辑 并被R2在边沿④处采样。如果时钟偏差为正，那么信号由R1传播到R2，的==可⽤时间就增加==了⼀ 个$\delta$时钟偏差值 。组合逻辑的输出;必领在 CLK上升沿(点④）的一个建⽴时间之前有效。于是对这⼀最⼩时钟周期的约束就可以推导如下：
$$T+\delta\geqslant t_{c-q}+t_{logic}+t_{su}\quad\text{或}\quad T\geqslant t_{c-q}+t_{logic}+t_{su}-\delta $$
该式提示我们时钟偏差实际上具有改善电路性能的可能。也就是电路可靠工作所要求的最小时钟周期随时钟偏差的增加而减小！这的确没错，但可惜的是，增加偏差会使电路对竞争情况更加敏感，而这有可能危及整个时序系统的正确工作。
##### b:保持时间
这⼀点可以⽤以下的例⼦来说明：再次假设输⼈ in 在CLK，的上升沿（即边沿①)处被采样进R1。R1输出端的新数据传播通过组合逻辑并且应当在 CLK的边沿④之前有效。然⽽，如果组合逻辑块的最⼩延时很⼩，<font color="#ff0000">那么R2的输⼈就有可能在时钟边沿②之前改变，导致求值出错。</font>为 了避免竞争，我们必领保证通过寄存器和逻辑的最⼩传播延时⾜够长，以使==R2的输⼈在边沿② 之后的⼀段维持时间内保持有效==。这⼀约束可以表⽰成：$$\delta+t_{hold}<t_{(c-q,cd)}+t_{(logic,cd)}$$
或者
$$\delta<t_{(c-q,cd)}+t_{(logic,cd)}-t_{hold}$$
##### c:总结
**正的始终偏差, 减小了对于建立时间的约束, 使得周期减小, 其余的都可以反推出来**

#### B:为何会有正负
根据布线⽅向和时钟源的位置，时钟偏差可以有正有负.![[support/img/Pasted image 20240115220228.png|500]]
遗憾的是，由于在⼀般的逻辑电路中数据可以在两个⽅向上流动(如具有反馈的电路)，所以 这种消除竞争的⽅法并不总能奏效。图 10.9 品⽰的是根据数据传送的⽅向时钟偏差值可正可 负。在这些情况下，设计者必领考虑最坏情况 下的时钟偏差。⼀般来说，使时钟布线只发⽣负偏 差是不现实的。因此，设计⼀个偏差⼩的时钟⽹络才是最重要的。![[support/img/Pasted image 20240115220312.png|500]]
### (2)时钟抖动 ( Clock Jitter)
- 定义: 时钟抖动是指在芯⽚的<font color="#ff0000">某⼀个给定点上时钟周期发⽣暂时的变化</font>，即时钟周期在每个不同的周期上可以缩短或加⻓。
- 特点: 时钟抖动是严格衡量时钟暂时不确定性的⼀项指标，并且经常针对 某⼀给定点进⾏说明。抖动可以⽤许多⽅法来衡量和表征，它是⼀个**零均值随机变量**。
- 绝对抖动$t_{jitter}$: 是指在某⼀给定位置处的⼀个时钟边沿相对于理想的周期性参照时钟边沿在<font color="#ff0000">最坏情形下 的变化(绝对值）</font>。
- 周期⾄周期抖动$T_{jitter}$: ⼀般是指某单个时钟周期相对于理想参照时钟的时变(time-varying)偏离
- 计算周期至周期抖动: $$T_{jitter}^{i}(n)=t_{clk,n+1}^{i}-t_{clk,n}^{i}-T_{CLK}$$
	- $\text{其中 }t_{clk,n+1}^i\text{和 }t_{clk,n}^i$分别代表第⼏+1个和第n个时钟边沿到达节点之的时间
	- $T_{CLK}$是指名义时钟周期
	在最坏的情况下, 周期⾄周期抖动的值等于绝对抖动的2倍$t_{jitter}$
#### A:时钟抖动的影响
这里的分析和之前的分析不同点在于, 由于每个点的时钟抖动是时变的, 因此,总要考虑最坏的情况, 因为指不定, 最坏的情况就发生了.
##### a:性能
![[support/img/Pasted image 20240115222837.png|350]]
![[support/img/Pasted image 20240115222825.png]]
*?????????咋不说对于保持时间的影响啊*
#### B:时钟抖动和时钟偏差的共同影响
##### a:正偏差
**性能|时钟周期**
假设由于时钟分布的原因，两个寄存器上的时钟信号之间存在一个静态偏差 δ( 假设 δ>0)。
而且，两个时钟都有抖动$t_{jiti\sigma}$。为了确定对最小时钟周期的限制，必须先看一下完成所要求的计算可用的最小时间是多少。最坏情况发⽣在 CLK1的当前时钟周期的上升沿推迟出现(边沿③）⽽ CIK2的下⼀个时钟周期的上升沿提前出现(边沿 ）时。由此得到了下列约束条件：$$T_{CLK}+\delta-2t_{jitter}\geqslant t_{c-q}+t_{logic}+t_{su}$$或$$T\geqslant t_{c-q}+t_{logic}+t_{su}-\delta+2t_{jitter}$$
上式表明，正偏差可以带来性能上的好处。反之，抖动总是对最⼩时钟周期有负⾯影响。
**最小延时|$\delta$**
为了推导最⼩延时约束公式，考虑 CLK1周期的上升沿提前到达(边沿①），⽽ CLK,当前周期 的上升沿推迟到达(边沿⑥）的情形。边沿①和边沿⑥之间的间隔时间应当⼩于经过整个电路的 最⼩延时。由此得到：$$\delta+t_{hold}+2t_{jitter}<t_{(c-q,cd)}+t_{(\log ic,cd)}$$或者$$\delta<t_{(c-q,cd)}+t_{(\log ic,cd)}-t_{hold}-2t_{jinter}$$==这⼀关系表明两个信号的抖动降低了可接受的时钟偏差值。==
##### b:负偏差
![[support/img/Pasted image 20240115224123.png]]

## 2.时钟偏差和抖动的来源
![[support/img/Pasted image 20240115225922.png|300]]
一个理想的时钟定义为同时触发芯片上各种存储元件的周期性信号。然而由于制造工艺和环境变化的不同，时钟并不那么理想。为了说明偏差和抖动的来源，考虑一个简化的典型时钟产生和分布网络，如图10.13所示。一个高频时钟可以由片外提供，也可以在片上产生。时钟从中心点出发，利用多条匹配路径向低层的时序元件分布。图中显示了两条路径。时钟路径包括导线以及相关的分布缓冲器，用以驱动互连线和负载。<font color="#ff0000">实现时钟分布时应当了解的关键点是经过时钟分布路径的绝对延时并不重要，重要的是它们到达每一条路径末端寄存器处的相对时间。 </font>只要所有的时钟同时到达芯片上所有的寄存器，那么时钟信号经过多个周期从中心分配点到达低层的寄存器是完全可以接受的。
有许多原因使这两条并⾏路径不能有完全相同的延时。时钟不确定性的来源可以按⼏种⽅式来分类。出错可以分为两类：
- 系统错误: 系统错误名义上在不同的芯⽚之间是完全⼀样的并且是**可以预⻅的**(如每条时钟路径上的总负载电容不同)。从理论上讲，只要有 ⾜够好的模型和模拟⼯具，这类错误可以在设计阶段进⾏模拟并⼦以纠正。简⾔之，系统错误可以通过测试⼀组芯⽚发现，然后通过调整设计来弥补。
- 随机错误: ⽽随机错误是由于制造中的变化产⽣的， 所以**很难模拟和消除(例如掺杂变化引起國值变化）。**
*那到底哪个是skew哪个是jitter呢??????*
## 3.时钟分布技术
### (1)时钟分布网络
- 设计要求
	- 使skew和jitter都最小
	-  降低功耗——可以控制和管理时钟
- 设计自由度
	- 导线材料的类型
	- 基本的拓扑和层次
	-  导线和缓冲器的尺寸
	- 上升和下降时间
	- 负载电容的划分
#### A:时钟网络的结构
最常⽤的时钟分布技术是⽇树⽹络(H-tree network)，如图 10.19的⼀个4×4 处理器阵列所示。⾸先把时钟连到芯⽚的中⼼点，然后包括匹配的互连线和缓冲器的均衡路径把参照 时钟分布到每⼀个叶节点上。在理想情况下，如果每⼀条路径 绝对均衡，那么时钟偏差就为零。尽管⼀个信号也许需要多个 时钟周期才能从中⼼点传播到每个叶节点，但到达每个叶节点 处的时间却是完全相同的。然⽽在实际中，由于制造过程和环 境的变化会造成时钟发⽣偏差和抖动。
![[support/img/Pasted image 20240115234914.png|400]]
- 所有子功能块与时钟源是等距离的，因此对于每 一个子功能块，时钟信号的延迟都是相同的
-  H-树形态是一个理想的模型，并且只适合于规整 的阵列网络。在这样的网络中，所有元素都是相 同的，并且时钟可以像二进制树那样分布
- H-树的概念可以<span style="background:#d3f8b6">延伸为匹配的RC-树</span>，即只需使 得时钟信号至子功能模块的互连线具有相同的长 度或相同的延迟时间
🌰![[support/img/Pasted image 20240115235348.png]]
### (2)网格结构
⽹格结构⼀般⽤在时钟⽹络的最 后⼀级，它把时钟分布到钟控元件负载上。这⼀⽅法与<span style="background:#d3f8b6">均衡 RC ⽅法</span>在原理上不同。*主要差别在 于最后⼀个驱动器到每⼀个负载的延时并不匹配*。<span style="background:#d3f8b6">但如果⽹格的尺⼨很⼩，那么它的绝对延时 也减到最⼩。</span>这样⼀个⽹格结构的主要优点是它允许在设计后期进⾏改动，这是由于在芯⽚上 的各个点处很容易得到时钟。遗憾的是，由于该结构具有许多“多余”的互连线，所以它的功耗损 失也相对较⼤。除了前⾯介绍的技术外，还设计出了其他⼀些时钟分布的⽅法。
![[support/img/Pasted image 20240115235837.png|500]]
### (3)🌰
![[support/img/Pasted image 20240115235942.png|500]]
![[support/img/Pasted image 20240115235947.png|500]]
### (4)如何处理时钟偏差和抖动问题
1. 为了使时**钟偏差最小，可以采用H-树等树状结构布线**， 使得从中央时钟到钟控元件的*路径均衡（RC匹配*，包 括元件和连线） 
2. 采用时钟网格可以减少时钟偏差，但是增加了电容和 功耗 
3. <span style="background:#d3f8b6">门控时钟</span>使得时钟负载和数据相关，<span style="background:#d3f8b6">从而增加时钟抖动；对固定负载较大的时钟网格中数据引起的变化不显著 </span>
4. 使数据的流动方向和时钟布线方向相反（δ<0）可以 消除竞争（hold），代价是性能降低
 5. 把电源线（VDD或GND）放在时钟线两侧可以屏蔽*数据线对时钟*的干扰 
 6.<span style="background:#d3f8b6"> 版图密度不均匀会造成绝缘介质层厚度不均，带来时钟偏差，应当采用虚设填料(filler)提高图形密度的 一致性</span>
 7. <font color="#ff0000">温度分布不均同样会引起时钟偏差，采用锁定环反馈 </font>技术可以进行补偿
 8. <span style="background:#d3f8b6">电源波动是引起抖动的重要原因</span>，增加片上去耦电容 可以减少高频的电源波动，但是需要耗费很大的面积， 因此必须采用有效的封装方法提供去耦电容
## 4.采用DLL分布时钟
**延时锁定环（Delay Locked Loop）**![[support/img/Pasted image 20240116000754.png]]
![[support/img/Pasted image 20240116001313.png|600]]
![[support/img/Pasted image 20240116001425.png|500]]
![[support/img/Pasted image 20240116001456.png|500]]
# 五、总结
同步系统的时钟问题：c<font color="#ff0000">lock skew，clock jitter</font>
主要的解决办法： 
 降低时钟负载与数据的相关性 
 降低工艺偏差 
 抑制环境噪声 
<font color="#ff0000"> 改善时钟分布 </font>
<font color="#ff0000"> 反馈调整：DLL</font>